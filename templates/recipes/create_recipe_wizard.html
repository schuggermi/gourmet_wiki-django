{% extends "base.html" %}
{% load i18n %}

{% block title %}
    {{ block.super }}
    - Craft your Recipe
{% endblock %}

{% block head %}
    {{ wizard.form.media }}
{% endblock %}

{% block main_content %}
    {% comment %}<div class="flex justify-between items-start">
        <h1 class="self-start flex flex-col gap-1">
            Craft your Recipe <br>
            {% include "partials/go_back.html" %}
        </h1>

        <ul class="steps steps-vertical step-base-300 lg:steps-horizontal w-3xl max-w-3xl">
            <li class="step {% if wizard.steps.current|add:"0" >= 0 %}step-secondary{% endif %}"><p
                    class="text-secondary!">
                Details</p></li>
            <li class="step {% if wizard.steps.current|add:"0" >= 1 %}step-secondary{% endif %}"><p
                    class="text-secondary!">
                Ingredients</p></li>
            <li class="step {% if wizard.steps.current|add:"0" >= 2 %}step-secondary{% endif %}"><p
                    class="text-secondary!">
                Images</p></li>
        </ul>
    </div>{% endcomment %}


    <div class="flex flex-col gap-10 w-full">
        <h1 class="self-start flex flex-col gap-1">
            Craft your Recipe <br>
            {% include "partials/go_back.html" %}
        </h1>

        <div class="self-center flex flex-col gap-10">
            <ul class="steps steps-vertical step-base-300 lg:steps-horizontal w-3xl max-w-3xl">
                <li class="step {% if wizard.steps.current|add:"0" >= 0 %}step-secondary{% endif %}">
                    <p class="text-secondary!">
                        Details
                    </p>
                </li>
                <li class="step {% if wizard.steps.current|add:"0" >= 1 %}step-secondary{% endif %}">
                    <p class="text-secondary!">
                        Ingredients
                    </p>
                </li>
                <li class="step {% if wizard.steps.current|add:"0" >= 2 %}step-secondary{% endif %}">
                    <p class="text-secondary!">
                        Preparation Steps
                    </p>
                </li>
                <li class="step {% if wizard.steps.current|add:"0" >= 3 %}step-secondary{% endif %}">
                    <p class="text-secondary!">
                        Images
                    </p>
                </li>
            </ul>
            <form action="" method="post" id="wizard-form" enctype="multipart/form-data" class="w-3xl max-w-3xl">
                {% csrf_token %}
                {{ wizard.management_form }}

                {% if wizard.form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ wizard.form.non_field_errors }}
                    </div>
                {% endif %}
                {% if wizard.form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ wizard.form.non_field_errors }}
                    </div>
                {% endif %}

                {% if wizard.steps.current == '0' %}
                    {% include "recipes/partials/recipe_details_form.html" with form=wizard.form %}
                {% elif wizard.steps.current == '1' %}
                    {% include 'recipes/partials/recipe_ingredients_form.html' with forms=wizard.form.forms form_index=forloop.counter0 %}
                {% elif wizard.steps.current == '2' %}
                    {% include 'recipes/partials/recipe_preparation_step_form.html' with forms=wizard.form.forms form_index=forloop.counter0 %}
                {% elif wizard.steps.current == '3' %}
                    {% include 'recipes/partials/recipe_images_form.html' with forms=wizard.form.forms form_index=forloop.counter0 %}
                {% endif %}

                <div class="flex gap-5">
                    {% if wizard.steps.prev %}
                        <button
                                name="wizard_goto_step"
                                type="submit"
                                value="{{ wizard.steps.prev }}"
                                class="btn bg-transparent! text-base-content! border-base-content! hover:border-secondary! hover:text-secondary! rounded-sm!"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                 stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
                            </svg>
                        </button>
                    {% endif %}
                    <button type="submit" class="btn btn-secondary rounded-sm! text-accent-content!">
                        {% if wizard.steps.current == wizard.steps.last %}
                            {% translate 'Create Recipe' %}
                        {% else %}
                            {% translate 'Next' %}
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>

    </div>

    <script>
        function reindexFormset(formsetSelector, totalFormsSelector) {
            console.log("Reindexing formset");
            const rows = document.querySelectorAll(`${formsetSelector} .formset-form`);
            const orderLabels = document.querySelectorAll('.preparation-step-label');
            const totalFormsInput = document.querySelector(totalFormsSelector);

            // Determine the prefix based on the formset selector
            let prefix = 'recipe_ingredient';
            if (formsetSelector === '#image-formset') {
                prefix = 'recipe_image';
            }
            if (formsetSelector === '#preparation-step-formset') {
                prefix = 'recipe_preparation_step';
            }

            rows.forEach((row, index) => {
                row.id = `${prefix}-${index}`;

                orderLabels.forEach((label, idx) => {
                    label.textContent = `${idx + 1}.`;
                    label.nextElementSibling.value = idx;
                });

                row.querySelectorAll('[name], [id], label[for]').forEach((el) => {
                    ['name', 'id', 'for'].forEach((attr) => {
                        if (el.hasAttribute(attr)) {
                            el.setAttribute(attr,
                                el.getAttribute(attr).replace(new RegExp(`${prefix}-\\d+|form-\\d+`, 'g'), `${prefix}-${index}`)
                            );
                        }
                    });
                });
            });

            if (totalFormsInput) {
                totalFormsInput.value = rows.length;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            if (document.querySelector('#ingredient-formset')) {
                reindexFormset('#ingredient-formset', '#id_recipe_ingredient-TOTAL_FORMS');
            }
            if (document.querySelector('#image-formset')) {
                reindexFormset('#image-formset', '#id_recipe_image-TOTAL_FORMS');
            }
            if (document.querySelector('#preparation-step-formset')) {
                reindexFormset('#preparation-step-formset', '#id_recipe_preparation_step-TOTAL_FORMS');
            }
        });
    </script>
{% endblock %}
