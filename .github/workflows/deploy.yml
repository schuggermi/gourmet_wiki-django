name: Deploy to Production (Hetzner)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    environment: rocky-4gb-fsn1-2
    runs-on: ubuntu-latest

    steps:
      - name: Print env vars
        env:
          USER: ${{ secrets.USER }}
          HOST: ${{ secrets.HOST }}
        run: |
          echo "User: $USER"
          echo "Host: $HOST"

      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # 3. Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Run Django tests
      - name: Run Django tests
        run: |
          python manage.py test

      - name: Add SSH key and scan host
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_HOST: ${{ secrets.HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Test SSH connection
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
          USER: ${{ secrets.USER }}
          HOST: ${{ secrets.HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $USER@$HOST 'echo "Connected!"'

      - name: Deploy to Hetzner server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/deployer/gourmet_wiki-django
            git pull origin master
            docker compose pull
            docker compose up -d --build
