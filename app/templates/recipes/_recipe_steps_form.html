{% load i18n %}

<ul id="steps"
    class="mb-10 flex flex-col gap-2 ps-0"
    hx-post="{% url 'steps_reorder' recipe.id %}"
    hx-trigger="end from:body"
    hx-include="#steps"
    hx-swap="none"
>
  {% for step in recipe.steps.all %}
    <li class="flex gap-2" data-step-id="{{ step.id }}">
        <div class="w-full grow-1 py-1 px-2 rounded-lg shadow-md {% if step.is_section %}bg-neutral text-neutral-content{% else %}bg-base-100{% endif %}">
            {% if step.is_section %}
            	<small class="w-full font-semibold text-neutral-content">{% translate 'Section' %}: {{ step.section_title }}</small>
            {% else %}
                {% comment %}<small><span class="w-full font-semibold">{{ step.order }}.</span> {{ step.step_text }}</small>{% endcomment %}
                <small>{{ step.step_text }}</small>
            {% endif %}
        </div>
        <div class="flex items-center">
            <p class="cursor-pointer w-fit"
               title="{% translate 'Remove this Preparation Step' %}"
               hx-delete="{% url 'step_delete' recipe.id step.id %}"
               hx-target="#recipe-steps-container"
               hx-swap="innerHTML"
               hx-confirm="{% translate 'Are you sure you want to remove this step?' %}"
            >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor"
                     class="size-6 text-error">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                </svg>
            </p>
            <span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor"
                     class="size-6 drag-handle cursor-grab">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
                </svg>
            </span>
        </div>
    </li>
  {% empty %}
      <li class="alert bg-neutral/10 border border-neutral rounded-lg">
          <small>{% translate 'No steps yet.' %}</small>
      </li>
  {% endfor %}
</ul>

<form id="recipe-steps-form"
      hx-post="{% url 'step_add' recipe.id %}"
      hx-swap="innerHTML"
      hx-target="#recipe-steps-container"
      class="grid grid-cols-1 gap-2 w-full"
      _="on change from #{{ step_form.is_section.id_for_label }}
        if #{{ step_form.is_section.id_for_label }}.checked
            remove .hidden from .section-title-field in me
            add .hidden to .step-text-field in me
            remove .hidden from .section-title-btn in me
            add .hidden to .step-text-btn in me
        else
            add .hidden to .section-title-field in me
            remove .hidden from .step-text-field in me
            add .hidden to .section-title-btn in me
            remove .hidden from .step-text-btn in me
        end
        on load
        if #{{ step_form.is_section.id_for_label }}.checked
            remove .hidden from .section-title-field in me
            add .hidden to .step-text-field in me
            remove .hidden from .section-title-btn in me
            add .hidden to .step-text-btn in me
        else
            add .hidden to .section-title-field in me
            remove .hidden from .step-text-field in me
            add .hidden to .section-title-btn in me
            remove .hidden from .step-text-btn in me
        end"
>
    {% csrf_token %}

    <div class="flex flex-col md:flex-row gap-2">
        <div class="section-title-field grow-1">
            <c-input :field="step_form.section_title" labeled w_full></c-input>
        </div>

        <div class="step-text-field grow-1">
            <c-input :field="step_form.step_text" labeled w_full></c-input>
        </div>

        <div class="col-span-1 flex items-start gap-1 shrink-0">
            <div title="{% translate 'This is a section/category header' %}">
                <c-input :field="step_form.is_section"
                         type="checkbox"
                         labeled
                         no_help
                ></c-input>
            </div>
        </div>
    </div>

    <button class="step-text-btn self-end btn btn-primary" type="submit">
        {% translate '+ Add Step' %}
    </button>
    <button class="section-title-btn self-end btn btn-primary" type="submit">
        {% translate '+ Add Section' %}
    </button>
</form>

<script>
    function initializeSortable() {
        const sortable = document.querySelector("#steps");

        if (sortable && !sortable.sortableInstance) {
            console.log("Initializing Sortable");

            sortable.sortableInstance = new Sortable(sortable, {
                animation: 150,
                dragClass: 'text-secondary!',
                handle: '.drag-handle',
                onEnd: function(evt) {
                    console.log("Sort ended");

                    // Get all items and their new order
                    const items = sortable.querySelectorAll('li[data-step-id]');
                    console.log("Found items:", items.length);

                    const orderData = Array.from(items).map((item, index) => {
                        console.log("Item:", item.dataset.stepId, "Order:", index + 1);
                        return {
                            id: item.dataset.stepId,
                            order: index + 1
                        };
                    });

                    console.log("Order data:", orderData);

                    if (orderData.length === 0) {
                        console.warn("No items to reorder!");
                        return;
                    }

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    // Send to server
                    fetch(sortable.getAttribute('hx-post'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: new URLSearchParams({
                            'order': JSON.stringify(orderData)
                        })
                    })
                    .then(response => {
                        console.log("Response status:", response.status);
                        if (response.ok) {
                            console.log("Reorder successful");
                        } else {
                            console.error("Reorder failed");
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                    });
                }
            });
        }
    }

    // Initial load
    window.addEventListener('load', initializeSortable);

    // Re-initialize after HTMX swaps
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        console.log("HTMX swap detected");
        // Remove old instance flag
        const sortable = document.querySelector("#steps");
        if (sortable) {
            delete sortable.sortableInstance;
        }
        initializeSortable();
    });
</script>