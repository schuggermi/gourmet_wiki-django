{% load i18n %}

<div id="recipe_preparation_step-{{ form_index }}" class="formset-form flex items-start gap-10 w-full">
    {{ form.id }}
    {{ form.order.as_hidden }}
    {{ form.DELETE.as_hidden }}

    <div class="formset-form-content flex gap-2 items-start w-full">
        <p class="step-label text-secondary font-bold">{{ form_index|add:"1" }}.</p>

        <!-- Step Text -->
        <div class="w-full border-t-2 border-ghost pt-2">
            <div class="flex items-start gap-2 justify-start w-full">
                <div class="flex flex-col gap-2 grow">
                    <div class="section-title-field {% if not form.is_section %}hidden{% else %}border-b-3 border-secondary rounded-md{% endif %}">
                        <c-input :field="form.section_title" no_errors></c-input>
                    </div>

                    <div class="step-text-field {% if form.is_section %}hidden{% endif %}">
                        <c-input :field="form.step_text" no_errors></c-input>
                    </div>
                </div>

                <div class="flex items-center gap-1 shrink-0">
                    <div>{{ form.is_section }}</div>
                    <p class="cursor-pointer self-center w-fit"
                       title="{% translate 'Remove this Preparation Step' %}"
                       onclick="this.closest('.formset-form').classList.add('hidden'); this.closest('.formset-form-content').remove(); document.getElementById('{{ form.DELETE.id_for_label }}').checked = true; document.getElementById('{{ form.DELETE.id_for_label }}').value = 'on'; reindexFormset('#preparation-step-formset', '#id_recipe_preparation_step-TOTAL_FORMS');"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor"
                             class="size-6 text-error">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"></path>
                        </svg>
                    </p>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                         stroke="currentColor"
                         class="size-6 drag-handle cursor-grab">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
                    </svg>
                </div>
            </div>

            <ul class="text-red-400 w-full">
                {% for error in form.is_section.errors %}
                    <li><small>{{ error }}</small></li>
                {% endfor %}
                {% for error in form.section_title.errors %}
                    <li><small>{{ error }}</small></li>
                {% endfor %}
                {% for error in form.step_text.errors %}
                    <li><small>{{ error }}</small></li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    (function() {
        const container = document.getElementById('recipe_preparation_step-{{ form_index }}');
        const checkbox = container.querySelector('input[type="checkbox"][name="{{ form.is_section.html_name }}"]');
        const sectionField = container.querySelector('.section-title-field');
        const stepField = container.querySelector('.step-text-field');
        const sectionInput = container.querySelector('[name="{{ form.section_title.html_name }}"]');
        const stepInput = container.querySelector('[name="{{ form.step_text.html_name }}"]');
        if (!checkbox || !sectionField || !stepField) return;
        const toggle = () => {
            if (checkbox.checked) {
                sectionField.classList.remove('hidden');
                stepField.classList.add('hidden');
            } else {
                sectionField.classList.add('hidden');
                stepField.classList.remove('hidden');
            }
        };
        checkbox.addEventListener('change', () => {
            // When switching types, keep the user's current text by moving it to the visible field if needed.
            if (checkbox.checked) {
                // switching to section: move step text into section title if section title is empty
                if (sectionInput && stepInput && (!sectionInput.value || sectionInput.value.trim() === '')) {
                    sectionInput.value = stepInput.value;
                }
            } else {
                // switching to normal step: move section title into step text if step text is empty
                if (sectionInput && stepInput && (!stepInput.value || stepInput.value.trim() === '')) {
                    stepInput.value = sectionInput.value;
                }
            }
            toggle();
        });
        toggle();
    })();
    </script>
