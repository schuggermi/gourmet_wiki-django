{% extends "base.html" %}
{% load i18n %}

{% block title %}
    {{ block.super }}
    {% if wizard.form.instance.pk %}
        - {% translate 'Edit Recipe' %}
    {% else %}
        - {% translate 'Add Recipe' %}
    {% endif %}
{% endblock %}

{% block head %}
    {{ wizard.form.media }}
{% endblock %}

{% block main_content %}
    <div class="container flex flex-col gap-10 pb-10 px-5">
        <div class="flex flex-col gap-1 w-full">
            <h1 class="self-start flex gap-5 items-center w-full">
                {% if wizard.form.instance.pk %}
                    <c-edit-recipe-icon size="size-6 sm:size-8 md:size-10 lg:size-12 xl:size-14"></c-edit-recipe-icon>
                    {% translate 'Edit Recipe' %}
                {% else %}
                    <c-add-recipe-icon size="size-6 sm:size-8 md:size-10 lg:size-12 xl:size-14"></c-add-recipe-icon>
                    {% translate 'Add Recipe' %}
                {% endif %}
            </h1>
            <c-go-back></c-go-back>
        </div>

        <div class="self-center flex flex-col gap-5 w-full max-w-screen md:max-w-xl">
            <ul class="ps-0 list-none steps steps-vertical step-neutral md:steps-horizontal w-full">
                <li class="step {% if wizard.steps.current|add:'0' >= 0 %}step-neutral{% endif %}">
                    {% translate 'Details' %}
                </li>
                <li class="step {% if wizard.steps.current|add:'0' >= 1 %}step-neutral{% endif %}">
                    {% translate 'Ingredients' %}
                </li>
                <li class="step {% if wizard.steps.current|add:'0' >= 2 %}step-neutral{% endif %}">
                    {% translate 'Preparation' %}
                </li>
                <li class="step {% if wizard.steps.current|add:'0' >= 3 %}step-neutral{% endif %}">
                    {% translate 'Images' %}
                </li>
            </ul>
            <form method="post" id="wizard-form" enctype="multipart/form-data"
                  class="w-full flex flex-col gap-10 bg-base-200 p-4 xl:p-10 rounded-lg">
                {% csrf_token %}
                {{ wizard.management_form }}

                {% if wizard.form.non_form_errors %}
                    <div class="alert alert-outline alert-error rounded-sm">
                        {{ wizard.form.non_form_errors }}
                    </div>
                {% endif %}

                {% if wizard.form.non_field_errors %}
                    <div class="alert alert-outline alert-error rounded-sm">
                        {{ wizard.form.non_field_errors }}
                    </div>
                {% endif %}

                {% if wizard.steps.current == '0' %}
                    {% include "recipes/partials/recipe_details_form.html" with form=wizard.form %}
                {% elif wizard.steps.current == '1' %}
                    {% include 'recipes/partials/recipe_ingredients_form.html' with forms=wizard.form.forms form_index=forloop.counter0 %}
                {% elif wizard.steps.current == '2' %}
                    {% include 'recipes/partials/recipe_preparation_step_form.html' with forms=wizard.form.forms form_index=forloop.counter0 %}
                {% elif wizard.steps.current == '3' %}
                    {% include 'recipes/partials/recipe_images_form.html' with forms=wizard.form.forms form_index=forloop.counter0 %}
                {% endif %}

                <div class="flex gap-2 justify-between">
                    <button
                        name="wizard_goto_step"
                        type="submit"
                        value="{{ wizard.steps.prev }}"
                        class="btn btn-ghost btn-lg btn-outline {% if not wizard.steps.prev %}invisible{% endif %}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                             stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18"></path>
                        </svg>
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg">
                        {% if wizard.steps.current == wizard.steps.last %}
                            {% translate 'Create Recipe' %}
                        {% else %}
                            {% translate 'Next' %}
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.querySelector('#ingredient-formset')) {
                reindexFormset('#ingredient-formset', '#id_recipe_ingredient-TOTAL_FORMS');
            }
            if (document.querySelector('#image-formset')) {
                reindexFormset('#image-formset', '#id_recipe_image-TOTAL_FORMS');
            }
            if (document.querySelector('#preparation-step-formset')) {
                reindexFormset('#preparation-step-formset', '#id_recipe_preparation_step-TOTAL_FORMS');
            }
        });
    </script>
{% endblock %}
