{% extends "base.html" %}
{% load i18n %}

{% block main_content %}
	<div class="bg-base-300 w-full container flex flex-col gap-10 py-10 px-2 md:rounded-md md:px-10 md:my-10 lg:max-w-3xl">
        <header class="w-full">
            <h1>{% translate 'Edit Recipe' %}</h1>
            <p>{% translate 'Add Ingredients, Steps and other Details' %}</p>
        </header>
    
        <div class="w-full flex flex-col gap-20">
            <!-- RECIPE DETAILS -->
            <div>
                <p class="h4 mb-1">{% translate 'Details' %}</p>

                <div class="w-full bg-base-200 p-5 shadow-md rounded-md">
                    {% include 'recipes/_recipe_details_form.html' %}
                </div>
            </div>

            <!-- RECIPE IMAGES -->
            <div>
                <p class="h4 mb-1">{% translate 'Images' %}</p>

                <div id="recipe-images-container" class="w-full bg-base-200 p-5 shadow-md rounded-md">
                    {% include 'recipes/_recipe_images_form.html' %}
                </div>
            </div>

            <!-- RECIPE INGREDIENTS -->
            <div>
                <p class="h4 mb-1">{% translate 'Ingredients' %}</p>

                <div id="recipe-ingredients-container" class="w-full bg-base-200 p-5 shadow-md rounded-md">
                    {% include 'recipes/_recipe_ingredients_form.html' %}
                </div>
            </div>

            <!-- RECIPE STEPS -->
            <div>
                <p class="h4 mb-1">{% translate 'Steps' %}</p>

                <div id="recipe-steps-container" class="w-full bg-base-200 p-5 shadow-md rounded-md">
                    {% include 'recipes/_recipe_steps_form.html' %}
                </div>
            </div>

            {% if user.profile.is_author %}
            	<!-- RECIPE PUBLISHING -->
                <div>
                    <p class="h4 mb-1">{% translate 'Publish' %}</p>

                    <div id="recipe-publish-container" class="w-full bg-base-200 p-5 shadow-md rounded-md">
                        {% include 'recipes/_recipe_publish_form.html' %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        function initializeSortable() {
            const sortable = document.querySelector("#steps");

            if (sortable && !sortable.sortableInstance) {
                console.log("Initializing Sortable");

                sortable.sortableInstance = new Sortable(sortable, {
                    animation: 150,
                    dragClass: 'text-secondary!',
                    handle: '.drag-handle',
                    onEnd: function(evt) {
                        console.log("Sort ended");

                        // Get all items and their new order
                        const items = sortable.querySelectorAll('li[data-step-id]');
                        console.log("Found items:", items.length);

                        const orderData = Array.from(items).map((item, index) => {
                            console.log("Item:", item.dataset.stepId, "Order:", index + 1);
                            return {
                                id: item.dataset.stepId,
                                order: index + 1
                            };
                        });

                        console.log("Order data:", orderData);

                        if (orderData.length === 0) {
                            console.warn("No items to reorder!");
                            return;
                        }

                        // Get CSRF token
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                        // Send to server
                        fetch(sortable.getAttribute('hx-post'), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': csrfToken
                            },
                            body: new URLSearchParams({
                                'order': JSON.stringify(orderData)
                            })
                        })
                        .then(response => {
                            console.log("Response status:", response.status);
                            if (response.ok) {
                                console.log("Reorder successful");
                            } else {
                                console.error("Reorder failed");
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                        });
                    }
                });
            }
        }

        window.addEventListener('load', initializeSortable);

        // Re-initialize after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            console.log("HTMX swap detected");
            // Remove old instance flag
            const sortable = document.querySelector("#steps");
            if (sortable) {
                delete sortable.sortableInstance;
            }
            initializeSortable();
        });
    </script>
{% endblock %}
