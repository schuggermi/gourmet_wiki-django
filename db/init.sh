#!/bin/bash
set -e

echo "Starting DB init..."

# Create DBs and users using the default POSTGRES_DB
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    CREATE DATABASE "${WEB_POSTGRES_DB}";
    CREATE DATABASE "${EMT_POSTGRES_DB}";

    CREATE USER "${WEB_POSTGRES_USER}" WITH PASSWORD '${WEB_POSTGRES_PASSWORD}';
    CREATE USER "${EMT_POSTGRES_USER}" WITH PASSWORD '${EMT_POSTGRES_PASSWORD}';

    GRANT ALL PRIVILEGES ON DATABASE "${WEB_POSTGRES_DB}" TO "${WEB_POSTGRES_USER}";
    GRANT ALL PRIVILEGES ON DATABASE "${EMT_POSTGRES_DB}" TO "${EMT_POSTGRES_USER}";
EOSQL

# Grant schema and default privileges in WEB_POSTGRES_DB
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "${WEB_POSTGRES_DB}" <<-EOSQL
    GRANT USAGE ON SCHEMA public TO "${WEB_POSTGRES_USER}";
    GRANT CREATE ON SCHEMA public TO "${WEB_POSTGRES_USER}";

    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "${WEB_POSTGRES_USER}";
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "${WEB_POSTGRES_USER}";
EOSQL

# Grant schema and default privileges in EMT_POSTGRES_DB
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "${EMT_POSTGRES_DB}" <<-EOSQL
    GRANT USAGE ON SCHEMA public TO "${EMT_POSTGRES_USER}";
    GRANT CREATE ON SCHEMA public TO "${EMT_POSTGRES_USER}";

    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "${EMT_POSTGRES_USER}";
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "${EMT_POSTGRES_USER}";
EOSQL

echo "DB init finished."
